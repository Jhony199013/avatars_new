version: "3.8"

services:
  frontend:
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile
      args:
        NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
        SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
        HEYGEN_API_KEY: ${HEYGEN_API_KEY}
        S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
        S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
        S3_ENDPOINT: ${S3_ENDPOINT}
        S3_BUCKET: ${S3_BUCKET}

    container_name: avatars_frontend

    ports:
      - "3000:3000"

    # берет .env из корня проекта
    env_file:
      - .env

    environment:
      NODE_ENV: production
      # Явно передаем переменные окружения для гарантии доступности в runtime
      NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      HEYGEN_API_KEY: ${HEYGEN_API_KEY}
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_BUCKET: ${S3_BUCKET}

    restart: unless-stopped

    networks:
      - avatars_network

  # backend:
  #   build:
  #     context: .
  #     dockerfile: docker/backend/Dockerfile
  #   container_name: avatars_backend
  #   ports:
  #     - "8000:8000"
  #   env_file:
  #     - .env
  #   environment:
  #     NODE_ENV: production
  #   restart: unless-stopped
  #   networks:
  #     - avatars_network

  # worker:
  #   build:
  #     context: .
  #     dockerfile: docker/worker/Dockerfile
  #   container_name: avatars_worker
  #   env_file:
  #     - .env
  #   environment:
  #     NODE_ENV: production
  #   restart: unless-stopped
  #   networks:
  #     - avatars_network

networks:
  avatars_network:
    driver: bridge
